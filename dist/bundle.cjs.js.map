{"version":3,"file":"bundle.cjs.js","sources":["../src/index.js"],"sourcesContent":["import _ from 'lodash';\nimport pino from 'pino';\nimport als from 'async-local-storage';\n\nals.enable();\n\nexport default function lift() {\n  this.config.log = this.config.log || {};\n  let pretty;\n\n  if (this.config.log.pretty !== false) {\n    pretty = pino.pretty();\n    let prettyConfig = _.assign(\n      {\n        errorProps: ['extra'],\n      },\n      this.config.log.pretty\n    );\n    pino.pretty(prettyConfig);\n    pretty.pipe(process.stdout);\n  }\n\n  let logger = pino(this.config.log, pretty);\n  this.logger = logger;\n\n  logger.log = logger.info.bind(logger);\n\n  ['log', 'info', 'warn', 'error', 'trace'].forEach((key) => {\n    let originFn = logger[key].bind(logger);\n    logger[key] = function wrap(...args) {\n      let traceId = als.get('traceId');\n      if (!traceId) {\n        originFn(...args);\n      }\n      else if (args[0] instanceof Error) {\n        originFn(...[...args, als.get('traceId')]);\n      }\n      else {\n        originFn(...[als.get('traceId'), ...args]);\n      }\n    };\n  });\n\n  global.logger = logger;\n  global.als = als;\n  return logger;\n}\n"],"names":["als","enable","lift","config","log","pretty","pino","prettyConfig","_","assign","pipe","process","stdout","logger","info","bind","forEach","key","originFn","wrap","args","traceId","get","Error"],"mappings":";;;;;;;;AAIAA,IAAIC,MAAJ;AAEA,AAAe,SAASC,IAAT,GAAgB;OACxBC,MAAL,CAAYC,GAAZ,GAAkB,KAAKD,MAAL,CAAYC,GAAZ,IAAmB,EAArC;MACIC,MAAJ;;MAEI,KAAKF,MAAL,CAAYC,GAAZ,CAAgBC,MAAhB,KAA2B,KAA/B,EAAsC;aAC3BC,KAAKD,MAAL,EAAT;;QACIE,eAAeC,EAAEC,MAAF,CACjB;kBACc,CAAC,OAAD;KAFG,EAIjB,KAAKN,MAAL,CAAYC,GAAZ,CAAgBC,MAJC,CAAnB;;SAMKA,MAAL,CAAYE,YAAZ;WACOG,IAAP,CAAYC,QAAQC,MAApB;;;MAGEC,SAASP,KAAK,KAAKH,MAAL,CAAYC,GAAjB,EAAsBC,MAAtB,CAAb;OACKQ,MAAL,GAAcA,MAAd;SAEOT,GAAP,GAAaS,OAAOC,IAAP,CAAYC,IAAZ,CAAiBF,MAAjB,CAAb;GAEC,KAAD,EAAQ,MAAR,EAAgB,MAAhB,EAAwB,OAAxB,EAAiC,OAAjC,EAA0CG,OAA1C,CAAmDC,GAAD,IAAS;QACrDC,WAAWL,OAAOI,GAAP,EAAYF,IAAZ,CAAiBF,MAAjB,CAAf;;WACOI,GAAP,IAAc,SAASE,IAAT,CAAc,GAAGC,IAAjB,EAAuB;UAC/BC,UAAUrB,IAAIsB,GAAJ,CAAQ,SAAR,CAAd;;UACI,CAACD,OAAL,EAAc;iBACH,GAAGD,IAAZ;OADF,MAGK,IAAIA,KAAK,CAAL,aAAmBG,KAAvB,EAA8B;iBACxB,GAAG,CAAC,GAAGH,IAAJ,EAAUpB,IAAIsB,GAAJ,CAAQ,SAAR,CAAV,CAAZ;OADG,MAGA;iBACM,GAAG,CAACtB,IAAIsB,GAAJ,CAAQ,SAAR,CAAD,EAAqB,GAAGF,IAAxB,CAAZ;;KATJ;GAFF;SAgBOP,MAAP,GAAgBA,MAAhB;SACOb,GAAP,GAAaA,GAAb;SACOa,MAAP;;;;;"}